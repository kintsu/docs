---
author: joshua-auchincloss
components:
  - compiler
  - parser
created: 2025-10-30
kind: SPEC
number: 3
status: draft
title: Anonymous Struct Compilation
updates:
  - author: joshua-auchincloss
    date: 2025-10-30
    description: Created specification
version_after: 0.1.0
version_before: null
---

# SPEC-0003: Anonymous Struct Compilation

## Overview

This SPEC documents the compiler's deterministic behavior for extracting and registering anonymous structs. It specifies the exact extraction algorithm, the name-generation context-tracking mechanism, and the order of operations that ensure generated structs are registered before their containing types. This SPEC is normative for implementers who must reproduce the compiler's anonymous-struct handling.

## Motivation

Tooling, documentation, and code generators rely on stable generated names for anonymous structs. This SPEC records the precise extraction and naming algorithms so that implementations produce identical outputs for the same source schemas. The extraction phase runs before type registration to ensure all generated structs are available for dependency resolution.

![Anonymous Struct Extraction Flow](../../../../diagrams/anonymous_extraction.png)

## Deterministic compilation rules (normative)

> [!NOTE]
> These rules are normative for implementers of the Kintsu compiler.

### Extraction phase timing

Anonymous-struct extraction runs as Phase 1 of the type resolution process, before union identification and before type registration.

The compiler recursively scans all namespace children (structs, operations, oneofs, type aliases, nested namespaces) and identifies anonymous structs in type positions.

### Context-tracking for name generation

The compiler maintains a `NameContext` with a stack of strings representing the current lexical path: `[namespace, parent_type, field_name]`.

As the compiler descends into type expressions, it pushes/pops context elements:

- Push the struct name when entering a struct definition
- Push the field name when entering a field type
- Push "Result" when entering an operation return type
- Push "Variant{idx}" when entering a OneOf variant type

> [!IMPORTANT]
> When an anonymous struct is encountered, the compiler generates a name by joining the context stack with underscores and converting to PascalCase (using `convert_case::Case::Pascal`).

### Nested extraction order (depth-first)

Fields within an anonymous struct may themselves have anonymous struct types. The compiler processes nested anonymous structs recursively before synthesizing the parent struct.

**Example:** If field `a` has an anonymous struct with field `b` that has an anonymous struct, the compiler extracts and names the nested struct for `b` first, then extracts the struct for `a`.

### Struct synthesis

For each extracted anonymous struct, the compiler calls `build_struct_def_from_anonymous` to create a `StructDef` with:

- Generated name (from context stack)
- Fields copied from the anonymous struct's field list
- Empty metadata (no top-level `#[...]` annotations)
- Reused brace tokens from the anonymous struct for span tracking

The synthesized `StructDef` is added to the namespace's children map with the generated name as the key.

### Registration

After extraction, generated structs are registered into the `TypeRegistry` during the normal struct-registration workflow (SPEC-0002).

Generated structs participate in dependency graphs and topological sorting like any explicitly declared struct.

## Acceptance criteria

- [ ] The compiler must extract anonymous structs during resolution Phase 1, before type registration begins.
- [ ] The compiler must generate names using the lexical context stack (namespace + parent type + field name) converted to PascalCase.
- [ ] Nested anonymous structs must be extracted depth-first so that inner nested shapes are named before outer shapes.
- [ ] Generated struct definitions must preserve field order, field separators (Required/Optional), and field-level comments/metadata from the source.
- [ ] Generated structs must have empty top-level metadata sections (no `#[...]` annotations).
- [ ] After extraction, generated structs must be registered into the `TypeRegistry` and participate in dependency resolution like explicitly declared structs.

## Design Principles

- Determinism: the extraction algorithm is reproducible; given the same source schema, the compiler always produces the same generated names and struct definitions.
- Phase separation: anonymous-struct extraction is a distinct phase that runs before union identification and type registration. This separation simplifies the compiler's pipeline and ensures all generated types are available for subsequent phases.

## Implications

- Schema authors can use anonymous structs freely, knowing that the compiler will generate stable, predictable names.
- Tooling must be aware of generated names when displaying diagnostics or documentation. Error messages should reference the source location (the inline braced struct) and the generated name.
- Code generators can treat generated structs as normal named structs; no special handling is required beyond understanding the name-generation algorithm for debugging.

## References

- [RFC-0003: Support Anonymous Structs](/rfc/rfc-0003)
- [TSY-0003: Anonymous Structs](/tsy/tsy-0003)
- [SPEC-0002: Struct Compilation](./SPEC-0002)
