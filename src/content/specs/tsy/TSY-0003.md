---
author: joshua-auchincloss
components:
  - compiler
  - parser
created: 2025-10-30
kind: TSY
number: 3
status: draft
title: Anonymous Structs
updates:
  - author: joshua-auchincloss
    date: 2025-10-30
    description: Created specification
version_after: 0.1.0
version_before: null
---

# TSY-0003: Anonymous Structs

## Overview

This document defines the normative type-system rules for anonymous structs in Kintsu. Anonymous structs are inline brace-delimited field lists used in type positions. The parser recognizes them as `AnonymousStruct` AST nodes, and the compiler extracts them into named struct definitions with generated identifiers. This TSY specifies the syntax, extraction rules, name-generation algorithm, and semantic guarantees that implementations must follow.

![Anonymous Struct Extraction Flow](../../../../diagrams/anonymous_extraction.png)

## Motivation

Anonymous structs allow schema authors to inline small composite types without declaring them separately. This TSY documents the exact syntax and extraction semantics so that schema authors and downstream tooling can rely on stable, predictable behavior. The name-generation algorithm is normative â€” implementations must reproduce the same generated names to ensure interoperability.

## Design Principles

- Determinism: name generation uses a reproducible lexical-context algorithm. Given the same source, the compiler always produces the same generated struct names.
- Transparency: generated structs are semantically equivalent to explicitly declared structs; they participate in the same validation, registration, and resolution workflows.
- Metadata preservation: field-level metadata and comments from the inline struct are carried through to the generated struct. Top-level metadata is not applicable (anonymous structs have no top-level declaration).

## Type system rules (normative)

### Syntax and parsing

An anonymous struct is a brace-delimited list of struct fields (Arg items) at a position where a type expression is expected.

```kintsu
struct Parent {
  config: {
    setting_a: str,
    setting_b: i32
  }
}
```

The parser produces an `AnonymousStruct` AST node containing the brace tokens and a `Repeated<Arg>` field list.

> [!NOTE]
> Anonymous structs can be nested arbitrarily: fields within an anonymous struct may themselves have anonymous struct types.

### Name generation algorithm

The compiler maintains a context stack (namespace path + parent type + field name) as it traverses type expressions.

When an anonymous struct is encountered, the compiler generates a name by concatenating the context stack elements using underscore separators and converting to PascalCase.

**Example:** namespace `config`, struct `AppConfig`, field `database` -> generated name `ConfigAppConfigDatabase`.

> [!IMPORTANT]
> If the anonymous struct appears inside a OneOf variant, the variant index is appended as a numeric suffix (e.g., `ParentVariant0`).

### Extraction and registration

During resolution (Phase 1: anonymous-struct extraction), the compiler scans all namespace children recursively, identifies anonymous structs in type positions, generates names, and synthesizes `StructDef` values.

Generated structs are added to the namespace's children map and registered into the `TypeRegistry` during the normal struct-registration workflow.

> [!NOTE]
> Generated structs have empty top-level metadata (no `#[...]` annotations). Field-level comments/metadata from the source are preserved in the fields.

### Semantic equivalence

After extraction, anonymous structs are indistinguishable from explicitly declared structs. They participate in dependency graphs, circular-dependency detection, and topological sorting.

Type references to generated structs use the generated name. Tooling and documentation generators should display generated names clearly so schema authors can reason about dependencies.

### Nested extraction order

The compiler processes anonymous structs depth-first: nested anonymous structs are extracted and named before their containing anonymous structs. This ensures that all nested shapes have stable names when the parent struct is synthesized.

## Implications

- Schema authors benefit from reduced boilerplate but must understand that inline structs are promoted to generated named types. Documentation and error messages must surface generated names clearly.
- Code generators and validators treat generated structs as normal named types; no special handling is required beyond understanding the name-generation algorithm for debugging.

## References

- [RFC-0003: Support Anonymous Structs](/specs/rfc/rfc-0003)
- [SPEC-0003: Anonymous Struct Compilation](/specs/spec/spec-0003)
- [TSY-0002: Struct Types](./TSY-0002)
