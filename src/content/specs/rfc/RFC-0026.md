---
author: joshua-auchincloss
components:
  - cli
created: 2025-12-26
kind: RFC
number: 26
status: draft
title: CLI Authentication Commands
updates:
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Added plaintext credential warning with confirmation prompt
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Removed browser OAuth flow, token-only authentication with interactive masking
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Created specification
version_after: 0.1.0
version_before: null
---

# RFC-0026: CLI Authentication Commands

## Summary

This RFC specifies the `login`, `logout`, and `whoami` CLI commands for managing registry authentication.

## Motivation

Authenticated access to registries is required for:

- Publishing packages
- Accessing private packages
- Rate-limit-free operations

These commands provide secure credential management using token-based authentication with system keychain storage.

## Specification

### kintsu login

Authenticates with a package registry using a token.

#### Synopsis

```
kintsu login [OPTIONS]
```

#### Options

| Option              | Short | Description                                               |
| ------------------- | ----- | --------------------------------------------------------- |
| `--registry <NAME>` | `-r`  | Registry to authenticate with (default: default registry) |
| `--token <TOKEN>`   | `-t`  | Use token directly instead of interactive prompt          |
| `--stdin`           |       | Read token from stdin                                     |
| `--no-keychain`     |       | Don't store credentials in system keychain                |

#### Behaviour

##### Interactive Token Entry (Default)

When run without `--token` or `--stdin`, the CLI prompts for token entry with character masking:

```
$ kintsu login
Token: ******
✓ Logged in to registry.kintsu.dev (kintsu-public) successfully
```

The token input:

- Is interactive (reads from terminal)
- Displays `*` for each character typed
- Never echoes the actual token to stdout
- Supports backspace for correction

##### Direct Token Flow

For non-interactive use:

```bash
# Direct token
kintsu login --token kint_xxxxxxxxxxxxxxxxxxxx

# Token from stdin (for CI)
echo "$KINTSU_TOKEN" | kintsu login --stdin
```

##### Credential Storage

| Priority | Location             | Condition                 |
| -------- | -------------------- | ------------------------- |
| 1        | System keychain      | Default on desktop        |
| 2        | File path            | Via `credential = "file"` |
| 3        | Environment variable | `KINTSU_TOKEN`            |

Keychain entries use:

- macOS: Keychain Access (`kintsu-registry-{name}`)
- Linux: libsecret/GNOME Keyring
- Windows: Windows Credential Manager

##### Plaintext Credential Warning

When storing credentials outside of OS keychain or environment variables (e.g., to a file), the CLI displays a security warning and requires confirmation:

```
$ kintsu login --no-keychain
Token: ******

⚠ Warning: This will store your token in plaintext, which is not recommended.
  Location: ~/.config/kintsu/tokens/default.token

Proceed? [y/N] y

✓ Logged in to registry.kintsu.dev (kintsu-public) successfully
Credentials stored in ~/.config/kintsu/tokens/default.token
```

Use `--yes` to suppress the confirmation prompt (for scripted environments):

```bash
kintsu login --no-keychain --yes
```

With `--no-keychain`, the CLI stores tokens in the location configured by `[auth].credential` in `kintsu.toml` (see [RFC-0022](/specs/rfc/rfc-0022)).

#### Examples

```bash
# Interactive login to default registry
kintsu login

# Login to specific registry
kintsu login --registry corp

# Login with token directly (CI environment)
kintsu login --token "$KINTSU_TOKEN"

# Login without keychain storage
kintsu login --no-keychain

# Login with token from stdin
echo "$TOKEN" | kintsu login --stdin --registry corp
```

#### Output

**Interactive flow:**

```
$ kintsu login
Token: ******
✓ Logged in to registry.kintsu.dev (kintsu-public) successfully

Credentials stored in system keychain.
```

**Direct token flow:**

```
  Validating token...
  ✓ Logged in as josh@kintsu.dev (expires: 2025-04-01)

  Credentials stored in system keychain.
```

**With `--no-keychain`:**

```
$ kintsu login --no-keychain
Token: ******
✓ Logged in to registry.kintsu.dev (kintsu-public) successfully

Credentials stored in ~/.config/kintsu/tokens/default.token
```

#### Error Conditions

| Condition                             | Description                      |
| ------------------------------------- | -------------------------------- |
| Authentication failed (invalid token) | Token not recognised by registry |
| Token expired                         | Token past expiration date       |
| Registry not configured               | Unknown registry name            |
| Credential store unavailable          | Keychain locked or inaccessible  |

---

### kintsu logout

Removes stored credentials for a registry.

#### Synopsis

```
kintsu logout [OPTIONS]
```

#### Options

| Option              | Short | Description                                          |
| ------------------- | ----- | ---------------------------------------------------- |
| `--registry <NAME>` | `-r`  | Registry to log out from (default: default registry) |
| `--all`             |       | Log out from all registries                          |

#### Behaviour

1. Remove credentials from keychain (if present)
2. Remove token file (if present)
3. Optionally revoke token with registry (if supported)

#### Examples

```bash
# Logout from default registry
kintsu logout

# Logout from specific registry
kintsu logout --registry corp

# Logout from all registries
kintsu logout --all
```

#### Output

```
  Logged out from registry.kintsu.dev
  Credentials removed from system keychain.
```

**All registries:**

```
  Logged out from 3 registries:
    - registry.kintsu.dev
    - corp.example.com
    - internal.mycompany.io
```

#### Error Conditions

| Condition                         | Description                         |
| --------------------------------- | ----------------------------------- |
| No credentials found for registry | Not logged in to specified registry |

---

### kintsu whoami

Displays the currently authenticated user.

#### Synopsis

```
kintsu whoami [OPTIONS]
```

#### Options

| Option              | Short | Description                                         |
| ------------------- | ----- | --------------------------------------------------- |
| `--registry <NAME>` | `-r`  | Check specific registry (default: default registry) |
| `--all`             |       | Show authentication for all registries              |
| `--json`            |       | Output in JSON format                               |

#### Behaviour

1. Look up stored credentials
2. Query registry API for user info
3. Display username and account details

#### Examples

```bash
# Check default registry
kintsu whoami

# Check specific registry
kintsu whoami --registry corp

# Check all registries
kintsu whoami --all

# JSON output for scripting
kintsu whoami --json
```

#### Output

**Single registry:**

```
  registry.kintsu.dev: josh@kintsu.dev
```

**All registries:**

```
  registry.kintsu.dev: josh@kintsu.dev
  corp.example.com: joshua.auchincloss
  internal.mycompany.io: (not authenticated)
```

**JSON format:**

```json
{
  "registry": "registry.kintsu.dev",
  "user": {
    "email": "josh@kintsu.dev",
    "username": "joshua-auchincloss",
    "name": "Joshua Auchincloss"
  },
  "token": {
    "created": "2025-01-01T00:00:00Z",
    "expires": "2025-04-01T00:00:00Z"
  }
}
```

#### Error Conditions

| Condition                       | Description                     |
| ------------------------------- | ------------------------------- |
| No credentials found            | Not logged in                   |
| Token expired                   | Token past expiration, re-login |
| Network error checking registry | Registry unreachable            |

---

## Environment Variables

| Variable              | Description                                 |
| --------------------- | ------------------------------------------- |
| `KINTSU_TOKEN`        | Default registry token (overrides keychain) |
| `KINTSU_TOKEN_{NAME}` | Registry-specific token (uppercase name)    |
| `KINTSU_NO_KEYCHAIN`  | Disable keychain storage                    |

## Security Considerations

### Token Storage

1. **Keychain preferred**: Uses OS-provided secure storage
2. **File permissions**: Token files created with mode `0600`
3. **Token format**: Prefixed (`kint_`) for accidental exposure detection
4. **No logging**: Tokens never written to logs or error messages
5. **Interactive masking**: Token input shows `*` characters, never actual token

### CI/CD Integration

```yaml
# GitHub Actions example
- name: Login to Kintsu
  run: echo "${{ secrets.KINTSU_TOKEN }}" | kintsu login --stdin

# Environment variable example
env:
  KINTSU_TOKEN: ${{ secrets.KINTSU_TOKEN }}
run: kintsu publish
```

## Acceptance Criteria

### AC-1: Login Interactive

Given no stored credentials, when `kintsu login` runs, then interactive prompt must appear with `*` masking.

### AC-2: Login Token Flow

Given `kintsu login --token xxx`, when run, then token must be validated and stored.

### AC-3: Login Keychain

Given successful login, when credentials stored, then they must be in system keychain.

### AC-4: Login No Keychain

Given `--no-keychain` flag, when logged in, then credentials must be in token file only.

### AC-5: Logout Single

Given stored credentials, when `kintsu logout` runs, then credentials must be removed.

### AC-6: Logout All

Given multiple stored credentials, when `kintsu logout --all` runs, then all must be removed.

### AC-7: Whoami Display

Given stored credentials, when `kintsu whoami` runs, then username must be displayed.

### AC-8: Whoami Not Authenticated

Given no credentials, when `kintsu whoami` runs, then appropriate message must be shown.

### AC-9: Environment Override

Given `KINTSU_TOKEN` set, when any command runs, then token must be used over keychain.

### AC-10: Token Never Echoed

Given any login flow, when token is entered, then actual token characters must never appear in stdout.

## References

- [RFC-0022](/specs/rfc/rfc-0022) - User Configuration
- [RFC-0021](/specs/rfc/rfc-0021) - Registry API
- [ERR-0012](/specs/err/err-0012) - Registry Errors
