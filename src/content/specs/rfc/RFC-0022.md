---
author: joshua-auchincloss
components:
  - compiler
created: 2025-12-25
kind: RFC
number: 22
status: draft
title: User Configuration
updates:
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Changed cache to SQLite database for registry packages, git deps only on filesystem
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Added explicit KINTSU_HOME platform defaults section
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Added cache configuration, KINTSU_HOME environment variable, cache directory structure
  - author: joshua-auchincloss
    date: 2025-12-25
    description: Created specification; enhanced code blocks with expressive-code titles
version_after: 0.1.0
version_before: null
---

# RFC-0022: User Configuration

## Abstract

This RFC specifies the user configuration file format for Kintsu. Configuration is loaded from multiple locations with a layered precedence model: project-local configuration overrides home configuration, which provides global defaults. This enables project-specific registry overrides while maintaining shared credentials.

## Motivation

Users need a way to configure:

1. **Registry Authentication** - Credentials for private registries
2. **Registry Discovery** - Additional registries beyond the default
3. **Default Behaviours** - Tool preferences and defaults
4. **Environment Integration** - CI/CD and container deployments
5. **Project-Specific Overrides** - Different registry settings per project
6. **Cache Management** - Control where downloaded packages are stored

The user configuration is separate from project manifests to:

- Keep credentials out of source control
- Share settings across projects
- Support different environments (dev/CI/prod)

Layered configuration enables:

- Global defaults in home configuration
- Project-specific overrides without duplicating credentials
- Simple CI/CD with universal token options

## Specification

### File Locations

Kintsu loads configuration from multiple locations, merging them in order of increasing precedence:

| Priority | Location                                   | Purpose                    |
| -------- | ------------------------------------------ | -------------------------- |
| 1 (low)  | `~/.config/kintsu.toml` (macOS/Linux)      | Global user defaults       |
| 1 (low)  | `%APPDATA%\kintsu\config.toml` (Windows)   | Global user defaults       |
| 2 (high) | `./.config/kintsu.toml` (relative to root) | Project-specific overrides |

The project-local configuration (`./.config/kintsu.toml`) is relative to the project root directory containing `schema.toml`.

The `KINTSU_CONFIG` environment variable, when set, replaces the home configuration location. It does not affect project-local configuration loading.

### Configuration Merging

When both home and project configurations exist, they are merged:

1. Start with the home configuration as the base
2. Apply project configuration as overrides
3. For `registries`: project entries override home entries with the same name; home entries with different names are preserved
4. For `default_registry`: project value overrides home value if specified

This additive model means a project can override specific registries while still having access to all registries defined in the home configuration.

#### Merge Example

```toml title="~/.config/kintsu.toml"
default_registry = "kintsu-public"

[[registries]]
name = "kintsu-public"
url = "https://registry.kintsu.dev"
token = { credentials = true }

[[registries]]
name = "corp-internal"
url = "https://schemas.corp.example.com"
token = { credentials = true }
```

```toml title=".config/kintsu.toml"
default_registry = "corp-internal"

[[registries]]
name = "corp-internal"
url = "https://schemas-dev.corp.example.com"  # Different URL for this project
token = { env = "DEV_TOKEN" }                  # Different auth for this project
```

Effective configuration:

- `default_registry` = `"corp-internal"` (from project)
- Registry `kintsu-public` from home (unchanged)
- Registry `corp-internal` from project (overrides home)

### File Structure

```toml
# Default registry for unprefixed dependencies
default_registry = "kintsu-public"

[[registries]]
name = "kintsu-public"
url = "https://registry.kintsu.dev"

[[registries]]
name = "corp-internal"
url = "https://schemas.corp.example.com"
token = { env = "CORP_SCHEMA_TOKEN" }
```

### Registries

The `[[registries]]` array configures available schema registries:

```toml
[[registries]]
name = "registry-name"           # Required: identifier for use in manifests
url = "https://registry.url"     # Required: registry API base URL
token = { ... }                  # Optional: authentication configuration
```

#### Registry Name

Registry names are used in manifest `registry` fields:

```toml
# In user config
[[registries]]
name = "corp-internal"
url = "https://schemas.corp.example.com"

# In schema.toml
[dependencies]
corp-types = { version = "^1.0", registry = "corp-internal" }
```

#### Registry URL

The URL is the base URL for the registry API. The compiler appends standard paths:

```
{url}/packages/{name}/{version}
{url}/packages/{name}/versions
```

### Authentication

The `token` field supports three authentication modes:

#### OS Keychain (Recommended)

```toml
[[registries]]
name = "kintsu-public"
url = "https://registry.kintsu.dev"
token = { credentials = true }
```

Uses the operating system's secure credential storage:

- macOS: Keychain
- Linux: Secret Service (libsecret)
- Windows: Credential Manager

Credentials are stored under the service name `kintsu:{registry-name}`.

#### Environment Variable

```toml
[[registries]]
name = "corp-internal"
url = "https://schemas.corp.example.com"
token = { env = "CORP_SCHEMA_TOKEN" }
```

Reads the token from the specified environment variable. Useful for:

- CI/CD pipelines
- Container deployments
- Ephemeral environments

#### File Path

```toml
[[registries]]
name = "docker-registry"
url = "https://schemas.internal"
token = { file = "/run/secrets/schema-token" }
```

Reads the token from a file path. The file is read as UTF-8 text with trailing whitespace stripped. Useful for:

- Docker secrets (`/run/secrets/...`)
- Kubernetes secrets mounted as files
- HashCorp Vault agent injected files

### Universal Token

For simple deployments where all registries use the same authentication, Kintsu supports a universal token:

#### Environment Variable

```bash
export KINTSU_REGISTRY_TOKEN="your-token-here"
kintsu check
```

#### Command-Line Flag

```bash
kintsu check --token "your-token-here"
```

The universal token is used for any registry that:

1. Does not have explicit `token` configuration in any loaded config file
2. Requires authentication (returns 401/403 without credentials)

Precedence for token resolution (highest to lowest):

1. `--token` CLI flag
2. `KINTSU_REGISTRY_TOKEN` environment variable
3. Registry-specific `token` configuration in project config
4. Registry-specific `token` configuration in home config
5. No authentication

The universal token is particularly useful for:

- CI/CD pipelines with a single service account
- Quick testing without configuring files
- Environments where file-based config is impractical

### Default Registry

The `default_registry` setting specifies which registry to use for unprefixed dependencies:

```toml
default_registry = "kintsu-public"
```

When a dependency doesn't specify a registry:

```toml
# In schema.toml
[dependencies]
some-pkg = "^1.0"  # Uses default_registry
```

If `default_registry` is not set, `kintsu-public` is used.

### Built-in Registry

The `kintsu-public` registry is always available without explicit configuration:

```toml
# This is implicit and does not need to be specified
[[registries]]
name = "kintsu-public"
url = "https://registry.kintsu.dev"
```

Users may override it to add authentication:

```toml
[[registries]]
name = "kintsu-public"
url = "https://registry.kintsu.dev"
token = { credentials = true }  # For publishing
```

### Complete Example

```toml
# ~/.config/kintsu.toml

# Cache configuration (optional)
[cache]
dir = "/custom/cache/path"

# Use corporate registry by default
default_registry = "corp-internal"

# Public registry (override to add auth for publishing)
[[registries]]
name = "kintsu-public"
url = "https://registry.kintsu.dev"
token = { credentials = true }

# Corporate internal registry
[[registries]]
name = "corp-internal"
url = "https://schemas.corp.example.com"
token = { env = "CORP_SCHEMA_TOKEN" }

# Partner registry with file-based auth (Docker secrets)
[[registries]]
name = "partner-schemas"
url = "https://schemas.partner.example.com"
token = { file = "/run/secrets/partner-token" }


```

### Cache Configuration

The `[cache]` table configures where Kintsu stores downloaded packages and git checkouts:

```toml
[cache]
dir = "/custom/cache/path"    # Override default cache directory
```

#### Cache Location Resolution

Cache directory is resolved in precedence order:

| Priority | Source                  | Value                     |
| -------- | ----------------------- | ------------------------- |
| 1 (high) | `KINTSU_CACHE_DIR` env  | Environment variable path |
| 2        | `[cache].dir` in config | Explicit configuration    |
| 3        | `KINTSU_HOME` env       | `$KINTSU_HOME/cache/`     |
| 4 (low)  | Platform default        | See below                 |

**Platform Defaults:**

| Platform | Default Cache Location           |
| -------- | -------------------------------- |
| macOS    | `~/.cache/kintsu/`               |
| Linux    | `~/.cache/kintsu/` (follows XDG) |
| Windows  | `%LOCALAPPDATA%\kintsu\cache\`   |

#### Cache Directory Structure

```
~/.cache/kintsu/
├── git/
│   └── {host}-{owner}-{repo}/
│       └── {commit-sha}/             # Git checkout at specific commit
│           └── schema/
│               └── *.ks
└── packages.db                       # SQLite database for registry packages
```

**Registry Package Cache (SQLite):**

Registry packages are stored in a SQLite database (`packages.db`). The database stores:

- Package manifests as JSON (UTF-8 enforced)
- Package index from registries
- File contents for downloaded packages

This approach provides:

- Efficient lookups without filesystem overhead
- Atomic transactions for cache updates
- Built-in integrity checking

**Git Dependency Cache:**

Git dependencies are the only dependencies written to the filesystem. They are checked out to the cache directory. The cache key is `{host}-{owner}-{repo}/{commit}/`. The host is extracted from the git URL (e.g., `github.com`), owner and repo from the path.

**Index Cache:**

Registry package indices are stored in the SQLite database alongside package data. These are periodically refreshed based on registry TTL headers.

#### Cache Behaviour

1. **Cache hit**: If cached package exists and checksum matches lockfile, use cached version
2. **Cache miss**: Fetch from registry/git and store in cache
3. **Checksum mismatch**: Re-fetch and update cache (log warning)
4. **Stale index**: Re-fetch index if older than registry TTL or `--refresh` flag used

> [!NOTE]
> Cache cleanup is currently manual. Run `kintsu cache clean` to remove unused packages. Automatic cleanup based on size limits is planned for a future release.

### Configuration Precedence

Settings are resolved in order (later overrides earlier):

1. Built-in defaults (`kintsu-public` registry)
2. Home configuration file (`~/.config/kintsu.toml`)
3. Project configuration file (`./.config/kintsu.toml`)
4. Environment variables
5. Command-line flags

For registry authentication specifically:

1. `--token` CLI flag (universal, applies to all registries)
2. `KINTSU_REGISTRY_TOKEN` environment variable (universal)
3. Registry-specific `token` in project config
4. Registry-specific `token` in home config
5. No authentication

### KINTSU_HOME Platform Defaults

`KINTSU_HOME` is the base directory for Kintsu configuration, cache, and data. When not explicitly set, it defaults to:

| Platform | Default `KINTSU_HOME`                                                    |
| -------- | ------------------------------------------------------------------------ |
| macOS    | `~/.kintsu/`                                                             |
| Linux    | `$XDG_DATA_HOME/kintsu/` (fallback: `~/.local/share/kintsu/` if not set) |
| Windows  | `%APPDATA%\kintsu\`                                                      |

When `KINTSU_HOME` is resolved, the following directories are created:

```
$KINTSU_HOME/
├── kintsu.toml          # User configuration
├── cache/               # Downloaded packages
├── templates/           # Custom scaffolding templates
└── credentials/         # Keychain fallback (if OS keychain unavailable)
```

### Environment Variables

| Variable                  | Description                                  |
| ------------------------- | -------------------------------------------- |
| `KINTSU_HOME`             | Override base directory for config and cache |
| `KINTSU_CONFIG`           | Override home configuration file location    |
| `KINTSU_CACHE_DIR`        | Override cache directory location            |
| `KINTSU_DEFAULT_REGISTRY` | Override default registry                    |
| `KINTSU_REGISTRY_TOKEN`   | Universal token for all registries           |
| `KINTSU_NO_CREDENTIALS`   | Disable OS keychain access                   |

#### KINTSU_HOME

When `KINTSU_HOME` is explicitly set via environment variable, it overrides the platform default and serves as the base directory for both configuration and cache:

- Configuration: `$KINTSU_HOME/kintsu.toml`
- Cache: `$KINTSU_HOME/cache/`
- Templates: `$KINTSU_HOME/templates/`

This is useful for:

- CI/CD environments with custom home directories
- Containerised builds with mounted volumes
- Testing with isolated environments

```bash
export KINTSU_HOME=/opt/kintsu
# Config at: /opt/kintsu/kintsu.toml
# Cache at:  /opt/kintsu/cache/
```

> [!TIP]
> `KINTSU_CONFIG` and `KINTSU_CACHE_DIR` override their respective `KINTSU_HOME` paths if you need finer control.

### Serialization

| Field                | Type              | Required | Default           |
| -------------------- | ----------------- | -------- | ----------------- |
| `default_registry`   | String            | No       | `"kintsu-public"` |
| `registries`         | Array of Registry | No       | `[]`              |
| `registries[].name`  | String            | Yes      | -                 |
| `registries[].url`   | String (URL)      | Yes      | -                 |
| `registries[].token` | TokenConfig       | No       | No auth           |
| `cache`              | CacheConfig       | No       | Platform default  |
| `cache.dir`          | String (path)     | No       | Platform default  |

#### TokenConfig

```
{ credentials = true }     # OS keychain
{ env = "VAR_NAME" }       # Environment variable
{ file = "/path/to/file" } # File path
```

Exactly one of `credentials`, `env`, or `file` must be specified.

#### CacheConfig

```toml
[cache]
dir = "/custom/path"       # Override cache directory
```

## Rationale

### Separate from Project Config

User configuration is separate from `schema.toml` because:

- Credentials should never be committed
- Settings vary by machine/environment
- Multiple projects share the same registries

### Multiple Auth Methods

Three authentication methods cover different deployment scenarios:

| Method        | Use Case                                     |
| ------------- | -------------------------------------------- |
| `credentials` | Developer workstations with secure storage   |
| `env`         | CI/CD pipelines, containers, cloud functions |
| `file`        | Docker secrets, Kubernetes, Vault            |

### XDG Base Directory

Following `~/.config/` on Unix systems aligns with:

- XDG Base Directory Specification
- Other development tools (rustup, npm, etc.)
- User expectations for config location

### Whitespace Stripping for File Tokens

Stripping trailing whitespace from file tokens prevents:

- Accidental newlines in secret files
- Editor auto-added trailing newlines
- Copy-paste errors

### Layered Configuration

The two-level configuration model (home + project) was chosen over alternatives:

**Single global config only**: Would require duplicating credentials across CI environments or committing secrets to project repos.

**Project config only**: Would require re-entering credentials for each project and lose shared registry definitions.

**Arbitrary config file stacking**: More complex than needed. Two levels (global defaults + project overrides) covers the common cases without configuration file discovery complexity.

The additive merge strategy (project overrides specific registries, others preserved) enables:

- Overriding a single registry URL for development
- Using different credentials per project
- Keeping access to all home-configured registries

### Universal Token

The `KINTSU_REGISTRY_TOKEN` and `--token` options exist for:

- CI/CD environments with single service accounts
- Quick testing without file configuration
- Containerized builds with injected secrets

This follows the pattern established by tools like npm (`NPM_TOKEN`) and cargo (`CARGO_REGISTRY_TOKEN`).

## Acceptance Criteria

- [ ] AC-1: Home configuration loads from platform-appropriate location
- [ ] AC-2: Project configuration loads from `./.config/kintsu.toml` relative to project root
- [ ] AC-3: Project config registries override home config registries by name
- [ ] AC-4: Home config registries not overridden remain available
- [ ] AC-5: `KINTSU_CONFIG` overrides home configuration location
- [ ] AC-6: All three registry-specific token types work correctly
- [ ] AC-7: `KINTSU_REGISTRY_TOKEN` provides universal token for unconfigured registries
- [ ] AC-8: `--token` CLI flag overrides all other token sources
- [ ] AC-9: File tokens strip trailing whitespace
- [ ] AC-10: Default registry falls back to `kintsu-public`
- [ ] AC-11: Registries are available for dependency resolution
- [ ] AC-12: Clear errors for missing required fields
- [ ] AC-13: `KINTSU_HOME` sets base directory for config and cache
- [ ] AC-14: `KINTSU_CACHE_DIR` overrides cache directory
- [ ] AC-15: `[cache].dir` configuration is respected
- [ ] AC-16: Cache directory structure matches specification
- [ ] AC-17: Registry packages are cached as MemoryFileSystem JSON
- [ ] AC-18: Git dependencies are checked out to cache

## Backwards Compatibility

This is the initial specification of the user configuration format. As user configuration is machine-local and not versioned, migrations can be handled by:

1. Adding new fields with sensible defaults
2. Deprecating old fields with warnings
3. Major changes prompt user to re-configure

The file format does not include a version field since:

- User config changes infrequently
- Breaking changes are rare
- Interactive migration is acceptable

## References

- [RFC-0019](/specs/rfc/RFC-0019) - Package Manifest Format
- [RFC-0020](/specs/rfc/RFC-0020) - Lockfile Format
- [SPEC-0021](/specs/spec/SPEC-0021) - User Configuration Implementation
