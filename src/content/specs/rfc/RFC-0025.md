---
author: joshua-auchincloss
components:
  - cli
created: 2025-12-26
kind: RFC
number: 25
status: draft
title: CLI Dependency Commands
updates:
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Prune now removes unused direct deps (not transitive), registry rejects unused deps
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Removed dev/optional/features flags, added prune command, changed aggressive to force
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Created specification
version_after: 0.1.0
version_before: null
---

# RFC-0025: CLI Dependency Commands

## Summary

This RFC specifies the `add`, `remove`, `update`, and `prune` CLI commands for managing schema dependencies.

## Motivation

Developers need intuitive commands to manage dependencies in their `schema.toml` manifests. These commands should handle:

- Adding new dependencies with version constraints
- Removing existing dependencies
- Updating locked versions
- Removing unused dependencies
- Workspace-aware operations

## Specification

### kintsu add

Adds one or more dependencies to the current schema manifest.

#### Synopsis

```
kintsu add [OPTIONS] <PACKAGES>...
```

#### Arguments

| Argument        | Description                                                    |
| --------------- | -------------------------------------------------------------- |
| `<PACKAGES>...` | One or more packages to add (format: `name` or `name@version`) |

#### Options

| Option              | Short | Description                                             |
| ------------------- | ----- | ------------------------------------------------------- |
| `--registry <NAME>` | `-r`  | Use specific registry                                   |
| `--workspace`       | `-w`  | Add to workspace.dependencies instead of current schema |
| `--dry-run`         |       | Show changes without modifying files                    |
| `--quiet`           | `-q`  | Suppress output                                         |

#### Behaviour

1. **Version Resolution**
   - If no version specified, fetch latest compatible version from registry
   - If `@version` specified, use that constraint
   - Validate version constraint syntax

2. **Manifest Modification**
   - Add entry to `[dependencies]`
   - Preserve existing formatting where possible
   - Sort entries alphabetically within sections

3. **Lockfile Update**
   - Resolve full dependency graph
   - Update `schema.lock.toml`
   - Fetch and cache packages

4. **Workspace Mode**
   - With `--workspace`, add to root `[workspace.dependencies]`
   - Member schemas can then use `.workspace = true`

#### Examples

```bash
# Add latest version of a package
kintsu add common-types

# Add with specific version constraint
kintsu add common-types@^2.0

# Add from specific registry
kintsu add --registry corp internal-types

# Add multiple packages
kintsu add common-types api-utils validation

# Add to workspace dependencies
kintsu add --workspace common-types
```

#### Output

```
  Adding common-types v2.3.1
  Updating schema.lock.toml
    Added common-types v2.3.1
    Added transitive-dep v1.0.0 (via common-types)
  Downloading 2 packages...
  Finished in 1.2s
```

#### Error Conditions

| Condition                                | Description                      |
| ---------------------------------------- | -------------------------------- |
| Package not found in registry            | No package with that name exists |
| No version satisfying constraint         | Version constraint can't be met  |
| Invalid version constraint syntax        | Malformed version string         |
| Dependency already exists (use `update`) | Package already in manifest      |
| No schema.toml found                     | Not in a package or workspace    |

---

### kintsu remove

Removes one or more dependencies from the current schema manifest.

#### Synopsis

```
kintsu remove [OPTIONS] <PACKAGES>...
```

#### Aliases

- `kintsu rm`

#### Arguments

| Argument        | Description                    |
| --------------- | ------------------------------ |
| `<PACKAGES>...` | One or more packages to remove |

#### Options

| Option        | Short | Description                          |
| ------------- | ----- | ------------------------------------ |
| `--workspace` | `-w`  | Remove from workspace.dependencies   |
| `--dry-run`   |       | Show changes without modifying files |
| `--quiet`     | `-q`  | Suppress output                      |

#### Behaviour

1. **Manifest Modification**
   - Remove entry from `[dependencies]`
   - Preserve formatting of remaining entries

2. **Lockfile Update**
   - Recalculate dependency graph
   - Remove packages no longer needed
   - Update `schema.lock.toml`

3. **Transitive Dependencies**
   - Only remove packages not required by other dependencies
   - Report orphaned packages being removed

#### Examples

```bash
# Remove a dependency
kintsu remove common-types

# Remove multiple packages
kintsu remove api-utils validation

# Remove from workspace
kintsu remove --workspace common-types
```

#### Output

```
  Removing common-types
  Updating schema.lock.toml
    Removed common-types v2.3.1
    Removed orphan: transitive-dep v1.0.0
  Finished in 0.3s
```

#### Error Conditions

| Condition                   | Description                           |
| --------------------------- | ------------------------------------- |
| Package not in dependencies | Package not found in current manifest |
| No schema.toml found        | Not in a package or workspace         |

---

### kintsu update

Updates locked dependency versions.

#### Synopsis

```
kintsu update [OPTIONS] [PACKAGES]...
```

#### Arguments

| Argument        | Description                         |
| --------------- | ----------------------------------- |
| `[PACKAGES]...` | Packages to update (all if omitted) |

#### Options

| Option        | Short | Description                                             |
| ------------- | ----- | ------------------------------------------------------- |
| `--force`     | `-f`  | Update to latest versions, ignoring current constraints |
| `--dry-run`   |       | Show updates without applying                           |
| `--recursive` | `-R`  | Also update transitive dependencies                     |
| `--workspace` | `-w`  | Update all workspace schemas                            |
| `--quiet`     | `-q`  | Suppress output                                         |

#### Behaviour

1. **Version Selection**
   - Default: find latest version within current constraint
   - Force: find latest version, suggest constraint update
2. **Lockfile Update**
   - Recalculate locked versions
   - Preserve versions of unaffected packages

3. **Workspace Mode**
   - Update unified lockfile at workspace root
   - Resolve versions for all workspace schemas together

#### Examples

```bash
# Update all dependencies
kintsu update

# Update specific package
kintsu update common-types

# Force update to latest version
kintsu update --force common-types

# Dry run to preview updates
kintsu update --dry-run

# Update workspace
kintsu update --workspace
```

#### Output

```
  Updating schema.lock.toml
    common-types: 2.3.1 -> 2.4.0
    api-utils: 1.0.0 (unchanged)
  Downloading 1 package...
  Finished in 0.8s
```

#### Force Mode Output

```
  Updating schema.lock.toml
    common-types: 2.3.1 -> 3.0.0 (breaking)

  ⚠ Breaking update detected:
    common-types ^2.0 -> ^3.0

  Update schema.toml? [y/N]
```

#### Error Conditions

| Condition                      | Description                    |
| ------------------------------ | ------------------------------ |
| No newer version available     | Already at latest compatible   |
| Dependency resolution failed   | Constraints can't be satisfied |
| Version conflict during update | Conflicting requirements       |
| No schema.toml found           | Not in a package or workspace  |
| No schema.lock.toml found      | Lockfile doesn't exist         |

---

### kintsu prune

Removes unused direct dependencies from the manifest. Note: The registry also rejects packages with unused direct dependencies during publish.

#### Synopsis

```
kintsu prune [OPTIONS]
```

#### Options

| Option        | Short | Description                          |
| ------------- | ----- | ------------------------------------ |
| `--workspace` | `-w`  | Prune across all workspace schemas   |
| `--dry-run`   |       | Show changes without modifying files |
| `--quiet`     | `-q`  | Suppress output                      |

#### Behaviour

1. **Static Analysis**
   - Compile schema to analyse imports
   - Identify which declared dependencies are actually used
   - Find direct dependencies with no imports

2. **Manifest Update**
   - Remove unused direct dependencies from `[dependencies]`
   - Update `schema.toml` with removed entries

3. **Lockfile Update**
   - Recalculate dependency graph
   - Remove packages no longer needed (including their transitives)

Note: Prune removes **direct** dependencies that have no imports in your schema code. Transitive dependencies are managed automatically—they are removed when no longer required by any direct dependency.

#### Examples

```bash
# Prune unused dependencies
kintsu prune

# Dry run to see what would be removed
kintsu prune --dry-run

# Prune entire workspace
kintsu prune --workspace
```

#### Output

```
  Analysing schema imports...
  Found 2 unused direct dependencies:

    Removing: old-types (not imported)
    Removing: unused-lib (not imported)

  Updating schema.toml
  Updating schema.lock.toml
    Pruned: old-types v1.0.0
    Pruned: old-types-transitive v0.5.0 (orphaned)
    Pruned: unused-lib v2.0.0
  Removed 3 packages
  Finished in 0.2s
```

#### Registry Validation

The registry performs the same static analysis during publish. If your package has unused direct dependencies, `kintsu publish` will fail:

```
error: package has unused direct dependencies

  Unused dependencies:
    - old-types (declared but not imported)

  hint: run `kintsu prune` to remove unused dependencies
```

#### Error Conditions

| Condition            | Description                   |
| -------------------- | ----------------------------- |
| No schema.toml found | Not in a package or workspace |
| No schema.lock.toml  | Lockfile doesn't exist        |

---

## Common Behaviours

### Workspace Detection

All commands automatically detect workspace context:

1. Search for `schema.toml` with `resolver` field
2. If found, operate in workspace mode
3. Commands respect `--workspace` flag to target root manifest

### Network Errors

All commands handle network failures gracefully:

| Condition            | Recovery                    |
| -------------------- | --------------------------- |
| Network timeout      | Retry with `--retry`        |
| Registry unavailable | Use cached data if possible |

### Lockfile Freshness

After any modification:

1. Verify lockfile matches manifest
2. Emit warning if out of sync
3. Auto-update lockfile unless `--no-lock`

## Acceptance Criteria

### AC-1: Add Basic

Given a schema.toml, when `kintsu add common-types` runs, then common-types must be added to `[dependencies]`.

### AC-2: Add Version

Given `kintsu add pkg@^2.0`, when run, then the exact constraint `^2.0` must be used.

### AC-3: Add Workspace

Given a workspace, when `kintsu add --workspace pkg` runs, then pkg must be added to `[workspace.dependencies]`.

### AC-4: Remove Basic

Given a dependency in schema.toml, when `kintsu remove pkg` runs, then the dependency must be removed.

### AC-5: Remove Orphans

Given transitive dependencies, when direct dependency is removed, then orphaned transitives must be removed.

### AC-6: Update All

Given a schema.lock.toml, when `kintsu update` runs, then all packages must be updated within constraints.

### AC-7: Update Specific

Given `kintsu update pkg`, when run, then only that package must be updated.

### AC-8: Prune Unused

Given unreferenced packages in lockfile, when `kintsu prune` runs, then they must be removed.

### AC-9: Dry Run

Given `--dry-run` flag, when any command runs, then no files must be modified.

### AC-10: Quiet Mode

Given `--quiet` flag, when command succeeds, then no output must be produced.

### AC-11: Error Exit Codes

Given any error condition, when command fails, then non-zero exit code must be returned.

## References

- [RFC-0019](/specs/rfc/rfc-0019) - Package Manifest Format
- [RFC-0020](/specs/rfc/rfc-0020) - Lockfile Format
- [RFC-0024](/specs/rfc/rfc-0024) - Workspace Manifest Format
- [ERR-0011](/specs/err/err-0011) - Package Errors
- [ERR-0012](/specs/err/err-0012) - Registry Errors
