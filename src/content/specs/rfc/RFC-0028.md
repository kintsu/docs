---
author: joshua-auchincloss
components:
  - cli
created: 2025-12-26
kind: RFC
number: 28
status: draft
title: CLI Publishing Commands
updates:
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Yank is now permanent (removed --undo), removed package structure/size limits sections
  - author: joshua-auchincloss
    date: 2025-12-26
    description: Created specification
version_after: 0.1.0
version_before: null
---

# RFC-0028: CLI Publishing Commands

## Summary

This RFC specifies the `publish` and `yank` CLI commands for publishing schemas to registries and managing published versions.

## Motivation

Schema authors need to:

- Publish schemas to registries for consumption
- Manage published versions (yank problematic releases)
- Verify packages before publishing

These commands ensure proper validation and secure publishing workflows.

## Specification

### kintsu publish

Publishes a schema to a registry.

#### Synopsis

```
kintsu publish [OPTIONS]
```

#### Options

| Option              | Short | Description                                 |
| ------------------- | ----- | ------------------------------------------- |
| `--registry <NAME>` | `-r`  | Target registry (default: default registry) |
| `--dry-run`         |       | Validate and package without uploading      |
| `--no-verify`       |       | Skip pre-publish verification               |
| `--allow-dirty`     |       | Allow publishing with uncommitted changes   |
| `--token <TOKEN>`   |       | Use specific token for authentication       |

#### Behaviour

##### Pre-publish Verification

Unless `--no-verify`:

1. **Clean working directory**
   - Check for uncommitted changes
   - Fail unless `--allow-dirty`

2. **Manifest validation**
   - Required fields present (`name`, `version`)
   - Valid package name format
   - Version follows semver

3. **File validation**
   - All referenced schema files exist
   - File-based fields (`{ path = "..." }`) are readable

4. **Dependency resolution**
   - All dependencies resolvable
   - No workspace-only references

5. **Compilation check**
   - Schema compiles without errors

##### Packaging

1. **File collection**
   - Include `schema.toml`
   - Include all `.ks` files from configured directories
   - Include files specified in `[package.include]`
   - Exclude files in `[package.exclude]`
   - Inline file-based fields (description, license, readme)

2. **Metadata extraction**
   - Parse manifest for registry metadata
   - Include README content for display

##### Upload

1. **Authentication check**
   - Verify token validity
   - Check publish permissions

2. **Upload package**
   - Stream package contents to registry
   - Registry validates and indexes

3. **Verification**
   - Confirm package published
   - Display package URL

#### Examples

```bash title="kintsu publish"
# Publish to default registry
kintsu publish

# Publish to specific registry
kintsu publish --registry corp

# Dry run (validate and package only)
kintsu publish --dry-run

# Publish with dirty working directory
kintsu publish --allow-dirty

# Skip verification (not recommended)
kintsu publish --no-verify
```

#### Output

**Success:**

```text title="kintsu publish"
  Verifying schema...
    ✓ Manifest valid
    ✓ Files present
    ✓ Dependencies resolved
    ✓ Schema compiles

  Packaging common-types v2.4.0...
    Included 15 files (24.5 KB)

  Uploading to registry.kintsu.dev...
    ✓ Published common-types v2.4.0

  https://registry.kintsu.dev/packages/common-types/2.4.0
```

**Dry run:**

```text title="kintsu publish --dry-run"
  Verifying schema...
    ✓ Manifest valid
    ✓ Files present
    ✓ Dependencies resolved
    ✓ Schema compiles

  Packaging common-types v2.4.0...
    Included 15 files (24.5 KB)

  Dry run complete. Package ready for publishing.
```

**Dirty warning:**

```text title="kintsu publish (dirty)"
error: working directory has uncommitted changes

  Modified files:
    schema/types.ks
    schema.toml

  hint: commit your changes before publishing
  hint: or use `--allow-dirty` to publish anyway
```

#### Error Conditions

| Condition                                   | Description                        |
| ------------------------------------------- | ---------------------------------- |
| No schema.toml found                        | Not in a package directory         |
| Invalid package name                        | Name doesn't match required format |
| Invalid version                             | Version not valid semver           |
| Version already exists                      | This version already published     |
| Authentication failed                       | Invalid or expired token           |
| Not authorised to publish                   | User lacks publish permissions     |
| Uncommitted changes (without --allow-dirty) | Working directory is dirty         |
| Verification failed                         | Pre-publish checks failed          |

---

### kintsu yank

Marks a published version as yanked. **This operation is permanent and cannot be undone.**

#### Synopsis

```
kintsu yank [OPTIONS] <VERSION>
```

#### Arguments

| Argument    | Description     |
| ----------- | --------------- |
| `<VERSION>` | Version to yank |

#### Options

| Option              | Short | Description                             |
| ------------------- | ----- | --------------------------------------- |
| `--registry <NAME>` | `-r`  | Target registry                         |
| `--reason <TEXT>`   |       | Reason for yanking (displayed to users) |

#### Behaviour

Yanking is a **permanent, irreversible operation**. Once yanked, a version cannot be un-yanked.

1. Authenticate with registry
2. Confirm the yank operation (interactive prompt unless `--yes`)
3. Mark version as yanked
4. Version remains downloadable for existing lockfiles
5. New resolutions will not select yanked version

#### Examples

```bash title="kintsu yank"
# Yank a version
kintsu yank 2.3.0

# Yank with reason
kintsu yank 2.3.0 --reason "Critical bug in struct compilation"

# Yank from specific registry
kintsu yank --registry corp 1.0.0
```

#### Output

```text title="kintsu yank (confirmation)"
  ⚠ Warning: Yanking is permanent and cannot be undone.

  You are about to yank: common-types v2.3.0

  Existing projects with this version locked can still download it.
  New dependency resolutions will skip this version.

  Continue? [y/N] y

  Yanking common-types v2.3.0...
  ✓ Yanked common-types v2.3.0
```

**With reason:**

```text title="kintsu yank --reason"
  Yanking common-types v2.3.0...
    Reason: Critical bug in struct compilation
  ✓ Yanked common-types v2.3.0
```

#### Error Conditions

| Condition              | Description                              |
| ---------------------- | ---------------------------------------- |
| Version not found      | Specified version doesn't exist          |
| Authentication failed  | Invalid or expired token                 |
| Not authorised         | User lacks yank permissions              |
| Version already yanked | Cannot re-yank an already yanked version |

---

## CI/CD Integration

### GitHub Actions

```yaml title=".github/workflows/publish.yml"
name: Publish
on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Kintsu
        uses: kintsu/setup-action@v1

      - name: Publish
        run: kintsu publish --token "${{ secrets.KINTSU_TOKEN }}"
```

### Semantic Versioning Check

```bash title="Pre-publish version check"
# Check for breaking changes before publish
kintsu diff HEAD~1

# Validate version bump matches changes
kintsu check-version
```

## Acceptance Criteria

### AC-1: Publish Basic

Given a valid schema, when `kintsu publish` runs, then package must be uploaded to registry.

### AC-2: Publish Dry Run

Given `--dry-run` flag, when `kintsu publish` runs, then no upload must occur.

### AC-3: Publish Verification

Given invalid schema, when `kintsu publish` runs, then error must be returned.

### AC-4: Publish Dirty Check

Given uncommitted changes, when `kintsu publish` runs, then error must be returned.

### AC-5: Publish Allow Dirty

Given `--allow-dirty`, when publishing with changes, then publish must succeed.

### AC-6: Yank Version

Given a published version, when `kintsu yank v1.0.0` runs, then version must be yanked.

### AC-7: Yank Permanent

Given a yanked version, when attempting to un-yank, then operation must not be possible.

### AC-8: Yank Reason

Given `--reason` flag, when yanking, then reason must be stored and displayed.

### AC-9: Yank Confirmation

Given interactive terminal, when yanking, then confirmation prompt must be shown.

### AC-10: File Inlining

Given file-based fields, when packaging, then content must be inlined.

## References

- [RFC-0019](/specs/rfc/rfc-0019) - Package Manifest Format
- [RFC-0021](/specs/rfc/rfc-0021) - Registry API
- [RFC-0026](/specs/rfc/rfc-0026) - CLI Authentication Commands
- [ERR-0011](/specs/err/err-0011) - Package Errors
- [ERR-0012](/specs/err/err-0012) - Registry Errors
