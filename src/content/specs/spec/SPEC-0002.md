---
author: joshua-auchincloss
components:
  - compiler
  - parser
created: 2025-10-30
kind: SPEC
number: 2
status: draft
title: Struct Compilation
updates:
  - author: joshua-auchincloss
    date: 2025-10-30
    description: Created specification
version_after: 0.1.0
version_before: null
---

# SPEC-0002: Struct Compilation

## Overview

This SPEC documents the compiler's concrete behavior for struct compilation: how the parser represents struct definitions in the AST, how struct definitions are validated and registered, and the deterministic ordering guarantees the compiler applies when registering types. Anonymous-struct extraction and union merging are described in separate SPECs (SPEC-0003 and SPEC-0007). The rules below are intentionally scoped to the lifecycle of `struct` types.

## Diagrams

The following diagrams illustrate the parser AST shape for `struct` declarations and the compilation registration flow used by the SchemaCompiler.

![Struct Types](../../../../diagrams/struct_types.png)

![Struct Compilation](../../../../diagrams/struct_compilation.png)

## Motivation

Tooling, generated documentation, and interop rely on deterministic compiler outputs. When the compiler synthesizes types (for anonymous structs or merged-union structs) it must produce stable names and a stable field layout. This SPEC records the exact algorithms implementers must follow to maintain stability across compiler versions that claim compatibility.

## Deterministic compilation rules (normative)

These rules are normative for implementers of the Kintsu compiler and for any consumers that reproduce the compiler's registration behavior for `struct` types.

1. Parser representation for structs

- The parser produces an AST `Struct` value with:
  - `kw`: the `struct` keyword token
  - `name`: an identifier token for the struct name
  - `brace`: the brace tokens delimiting the field list
  - `args`: a `Repeated` list of `Arg` items representing fields
  - `end`: terminating semicolon token

- Each `Arg` contains the field identifier, the separator token (mapped to `Sep`), the field type expression, and any parsed comments/meta attached to the field.

2. Validation rules for struct definitions

- Field names must be unique within a struct. Duplicate field names inside the same `struct` declaration are a validation error.
- Field separators (optional vs required) are preserved in the AST and must be carried forward to resolution phases so the registry and downstream tools can correctly interpret requiredness.

3. Type registration and ordering (how structs become visible)

- The SchemaCompiler registers `struct` definitions into the `TypeRegistry` during namespace registration. The registration process uses a topological grouping computed from the type dependency graph so that dependencies are registered before dependents.
- SCC detection is performed on the required-edge graph to detect non-terminating cycles. If a cycle contains no terminating edge, registration fails with `TypeCircularDependency` for the involved types. Terminating cycles (cycles containing at least one optional/terminating edge) are allowed.

- Registration implementation details:
  - `register_types_recursive` computes the dependency graph and topological groups.
  - `register_type` maps a `NamespaceChild::Struct` to a `Definition::Struct` and calls `schema.registry.register(...)`.

4. Diagnostics

- Duplicate field names, undefined type references referenced from struct fields, and non-terminating type cycles are reported as named diagnostics with helpful context and source spans.

Note: anonymous-struct extraction and union merging are out-of-scope for this SPEC and documented in SPEC-0003 and SPEC-0007 respectively.

## Acceptance criteria

- [ ] The compiler must register `struct` types into the `TypeRegistry` in an order that respects the dependency grouping produced by the topological sort algorithm; dependents must be registered after their dependencies.
- [ ] Field-level semantic properties parsed from source (identifier, separator/optionality, type expression, and attached metadata) must be preserved through resolution and visible to registration and downstream phases.
- [ ] Duplicate field names within a single `struct` declaration must be rejected with a validation diagnostic.
- [ ] When anonymous structs are promoted or unions are merged, the compiler's emitted names and field ordering must conform to the algorithms and stability guarantees defined in SPEC-0003 and SPEC-0007 respectively.
- [ ] Diagnostics for unresolved type references referenced from struct fields and for non-terminating type cycles must be emitted with source spans sufficient to locate the offending declarations.

## Design Principles

<!-- todo -->

## Implications

<!-- todo -->

## References

- [RFC-0002: Struct Types](/rfc/rfc-0002)
- [TSY-0002: Struct Types](/tsy/tsy-0002)
- [SPEC-0003: Anonymous Struct Compilation](./SPEC-0003)
- [SPEC-0007: Union Compilation and Merging](./SPEC-0007)
