---
author: joshua-auchincloss
components:
  - compiler
created: 2025-12-25
kind: SPEC
number: 21
status: draft
title: User Configuration Implementation
updates:
  - author: joshua-auchincloss
    date: 2025-12-25
    description: Created specification
version_after: 0.1.0
version_before: null
---

# SPEC-0021: User Configuration Implementation

## Overview

This specification defines the semantics of user configuration as specified in [RFC-0022](/specs/rfc/RFC-0022). Configuration is loaded from multiple locations with a layered precedence model.

## Motivation

The user configuration provides:

- Registry discovery and authentication
- Default settings for commands
- Environment-specific overrides
- Project-specific registry overrides

Correct implementation ensures secure credential handling and consistent behavior.

## Configuration File Locations

Configuration is loaded from two locations and merged:

**Home configuration**: Global user defaults.

- Unix: `$HOME/.config/kintsu.toml`
- Windows: `%APPDATA%\kintsu\config.toml`
- Override: `KINTSU_CONFIG` environment variable replaces the home path

**Project configuration**: Project-specific overrides.

- Path: `./.config/kintsu.toml` relative to the project root (directory containing `schema.toml`)
- Not affected by `KINTSU_CONFIG`

If neither configuration file exists, default settings are used. The compiler does not fail when configuration is missing.

## Configuration Merging

When both home and project configurations exist:

1. Load home configuration as the base
2. Load project configuration
3. For `default_registry`: project value overrides home value if present
4. For `registries`: merge by name. Project entries override home entries with the same name. Home entries with different names are preserved.

This produces an effective configuration where:

- All home-configured registries remain accessible
- Project can override specific registries (URL, credentials) without affecting others
- Project can set a different default registry

## Configuration Structure

### Root Fields

**default_registry** (string, optional): The name of the registry to use for dependencies that do not specify a registry. Defaults to `kintsu-public`.

**registries** (array, optional): Array of registry configurations. Each entry defines how to connect to and authenticate with a registry.

### Registry Configuration

Each registry entry contains:

**name** (string, required): Identifier for this registry. Used in dependency specifications and as the lookup key.

**url** (string, required): Base URL of the registry API. Must be a valid URL.

**token** (object, optional): Authentication configuration for this registry.

### Token Configuration

The token field specifies how to obtain authentication credentials. Exactly one method must be specified:

**credentials** (boolean): When true, use the operating system credential store. The credential is looked up using the key `kintsu:{registry_name}`.

**env** (string): Name of an environment variable containing the token.

**file** (string): Path to a file containing the token. The file contents are trimmed of trailing whitespace.

## Registry Resolution

When the compiler needs to connect to a registry:

1. Look up the registry name in the merged configuration's registries array
2. If not found and the name is `kintsu-public`, use the built-in default (URL: `https://registry.kintsu.dev`, no authentication)
3. If not found and not `kintsu-public`, report an error

The merged configuration means project-defined registries take precedence, but home-defined registries remain available.

The default registry for unprefixed dependencies is determined by:

1. If `KINTSU_DEFAULT_REGISTRY` environment variable is set, use that registry name
2. Otherwise, use the merged `default_registry` value (project overrides home)
3. If not configured, default to `kintsu-public`

## Token Resolution

When a registry requires authentication, tokens are resolved in precedence order:

1. `--token` CLI flag (if provided)
2. `KINTSU_REGISTRY_TOKEN` environment variable (if set)
3. Registry-specific `token` configuration from merged config
4. No authentication

The CLI flag and environment variable provide a universal token used for any registry that would otherwise have no configured authentication. This enables CI/CD pipelines to authenticate with a single token.

## Credential Resolution

When using registry-specific `token` configuration:

**For credentials method:**

1. If `KINTSU_NO_CREDENTIALS` environment variable is set, fail with credentials disabled
2. Construct the service key as `kintsu:{registry_name}`
3. Query the operating system credential store using platform-specific APIs
4. If no credential found, report an error

**For env method:**

1. Read the specified environment variable
2. If the variable is not set, report an error
3. Use the variable value as the token

**For file method:**

1. Read the specified file path
2. If the file cannot be read, report an error
3. Trim trailing whitespace from the contents
4. Use the trimmed contents as the token

## Built-in Registry

The `kintsu-public` registry is always available without configuration:

- Name: `kintsu-public`
- URL: `https://registry.kintsu.dev`
- Authentication: None required for public packages

Users can override this by defining their own `kintsu-public` entry in their configuration.

## Environment Overrides

The following environment variables affect configuration behavior:

| Variable                  | Effect                                |
| ------------------------- | ------------------------------------- |
| `KINTSU_CONFIG`           | Override home configuration file path |
| `KINTSU_DEFAULT_REGISTRY` | Override default registry name        |
| `KINTSU_REGISTRY_TOKEN`   | Universal token for all registries    |
| `KINTSU_NO_CREDENTIALS`   | Disable credential store access       |

## Validation Requirements

**At parse time (both config files):**

- TOML syntax must be valid
- URL fields must be parseable URLs
- Token configuration must have exactly one method specified

**During merging:**

- Invalid project config should not prevent loading valid home config (warn and continue)

**During registry lookup:**

- Registry name must be configured (in merged result) or be `kintsu-public`

**During credential resolution:**

- Credential store must contain the expected entry
- Environment variable must be set
- Token file must be readable

## Design Principles

### Secure by Default

Credentials use the operating system credential store by default. This avoids storing secrets in plaintext configuration files. Token files should have restricted filesystem permissions.

### Environment Flexibility

All critical settings can be overridden via environment variables. The universal token (`KINTSU_REGISTRY_TOKEN` and `--token`) enables CI/CD pipelines and containerized builds to authenticate without file configuration.

### Progressive Configuration

The system works with zero configuration using the built-in public registry. Users add home configuration for shared registries. Projects can override specific registries without duplicating the entire configuration.

### Additive Layering

Project configuration adds to and overrides home configuration rather than replacing it entirely. This ensures all home-defined registries remain accessible even when a project customizes one.

## Implications

### Security

Credentials are never stored in the configuration file itself. Token values should not appear in logs or error messages. Environment variables are visible to child processes, so sensitive tokens should use the credential store when possible.

### Cross-Platform

The credential store uses platform-native APIs: Keychain on macOS, Secret Service on Linux, Credential Manager on Windows. Path conventions follow platform standards.

### Caching

Configuration is loaded once per command invocation. Token resolution results are cached for the duration of the session. Registry configurations are immutable after loading.

## References

- [RFC-0022](/specs/rfc/RFC-0022) - User Configuration Format
- [SPEC-0018](/specs/spec/SPEC-0018) - Package Manifest Implementation
- [SPEC-0019](/specs/spec/SPEC-0019) - Lockfile Implementation
