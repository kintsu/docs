---
import SpecStatusBadge from "./SpecStatusBadge.astro";
import SpecChangelog from "./SpecChangelog.astro";
import { SpecKindBadge } from "./SpecKindBadge.tsx";
import { ComponentTagList } from "./ComponentTag.tsx";
import type { SpecSchema } from "../lib/specs";

const {
  title,
  kind,
  number,
  status,
  author,
  created,
  updates,
  version_after,
  version_before,
  components,
} = Astro.props as SpecSchema;

function formatDate(d: Date): string {
  return new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  }).format(d);
}

const createdDate = created instanceof Date ? created : new Date(created);
const lastUpdatedDate =
  updates.length > 0
    ? updates.reduce((acc, u) => {
        const d = u.date instanceof Date ? u.date : new Date(u.date);
        return acc > d ? acc : d;
      }, createdDate)
    : createdDate;

const kindLower = kind.toLowerCase();
---

<header class="spec-header" data-spec-kind={kindLower}>
  <div class="spec-title-row">
    <SpecKindBadge kind={kind} number={number} client:load />
    <h1 class="spec-title">{title}</h1>
  </div>

  <div class="spec-status-row">
    <SpecStatusBadge status={status} />
  </div>

  <div class="spec-meta-row">
    <div class="spec-meta-item">
      <span class="meta-label">Author</span>
      <span class="meta-value">{author}</span>
    </div>

    <div class="spec-meta-item">
      <span class="meta-label">Created</span>
      <time class="meta-value" datetime={createdDate.toISOString()}>
        {formatDate(createdDate)}
      </time>
    </div>

    <div class="spec-meta-item">
      <span class="meta-label">Updated</span>
      <time class="meta-value" datetime={lastUpdatedDate.toISOString()}>
        {formatDate(lastUpdatedDate)}
      </time>
    </div>

    <div class="spec-meta-item">
      <span class="meta-label">Version</span>
      <span class="meta-value">
        {version_before ? `${version_before} â†’ ${version_after}` : version_after}
      </span>
    </div>
  </div>

  {
    components.length > 0 && (
      <div class="spec-components">
        <span class="components-label">Components</span>
        <ComponentTagList components={components} kind={kind} client:load />
      </div>
    )
  }

  <SpecChangelog updates={updates} />
</header>

<style>
  .spec-header {
    padding-block: 1.5rem;
    border-block-end: 1px solid var(--sl-color-gray-5);
    margin-block-end: 2rem;
  }

  .spec-title-row {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-block-end: 1rem;
  }

  .spec-title {
    margin: 0;
    font-size: var(--sl-text-3xl);
    font-weight: 700;
    color: var(--sl-color-white);
    line-height: var(--sl-line-height-headings);
  }

  .spec-status-row {
    margin-block-end: 1.25rem;
  }

  .spec-meta-row {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 1.5rem 2.5rem;
    margin-block-end: 1.25rem;
  }

  .spec-meta-item {
    display: inline-flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .meta-label {
    font-size: var(--sl-text-xs);
    font-weight: 600;
    color: var(--sl-color-gray-3);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .meta-value {
    font-size: var(--sl-text-sm);
    font-weight: 500;
    color: var(--sl-color-gray-1);
  }

  .spec-components {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: var(--sl-color-gray-6);
    border-radius: 0.5rem;
    border: 1px solid var(--sl-color-gray-5);
    margin-block-end: 1rem;
  }

  .components-label {
    font-size: var(--sl-text-2xs);
    font-weight: 600;
    color: var(--sl-color-gray-3);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  @media (min-width: 50rem) {
    .spec-title {
      font-size: var(--sl-text-4xl);
    }
  }
</style>
